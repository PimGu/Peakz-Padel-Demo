<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Peakz Padel Singles Swipe Demo</title>
  <style>
    :root{
      --bg:#0b0f14;
      --text:#e9eef7;
      --muted:#a7b2c7;
      --accent:#27f2c7;
      --danger:#ff4d6d;
      --ok:#4dff88;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(1200px 800px at 50% -10%, rgba(39,242,199,.18), transparent 55%),
        radial-gradient(900px 700px at 110% 10%, rgba(255,77,109,.14), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100dvh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .app{
      width:min(420px, 100%);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 6px 0;
      gap:10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
      letter-spacing:.2px;
      min-width: 0;
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background:var(--accent);
      box-shadow: 0 0 0 6px rgba(39,242,199,.12);
      flex: 0 0 auto;
    }

    .brandText{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .rightTop{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid rgba(233,238,247,.12);
      padding:8px 10px;
      border-radius:999px;
      backdrop-filter: blur(10px);
      background: rgba(17,24,38,.55);
      white-space:nowrap;
    }

    .miniBtn{
      font-size:12px;
      font-weight:950;
      color:var(--text);
      border:1px solid rgba(233,238,247,.12);
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      cursor:pointer;
      white-space:nowrap;
    }

    .filters{
      display:flex;
      gap:10px;
      padding: 0 6px;
    }

    select{
      flex:1;
      appearance:none;
      border-radius:14px;
      border:1px solid rgba(233,238,247,.14);
      background: rgba(17,24,38,.65);
      color: var(--text);
      padding:12px 12px;
      font-weight:900;
      outline:none;
      backdrop-filter: blur(10px);
    }

    .deck{
      position:relative;
      height: 580px;
      border-radius: var(--radius);
      margin-top: 4px;
    }

    .card{
      position:absolute;
      inset:0;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(233,238,247,.12);
      box-shadow: var(--shadow);
      overflow:hidden;
      touch-action:none;
      user-select:none;
      transform: translate3d(0,0,0);
    }

    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(900px 520px at 50% 0%, rgba(39,242,199,.20), transparent 55%),
        radial-gradient(700px 520px at 0% 40%, rgba(255,77,109,.14), transparent 55%);
      pointer-events:none;
    }

    .photo{
      position:absolute;
      inset:0;
      background-size:cover;
      background-position:center;
      filter:saturate(1.05) contrast(1.05);
      transform: scale(1.02);
    }

    .shade{
      position:absolute;
      inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.0) 34%, rgba(0,0,0,.86) 100%);
    }

    .info{
      position:absolute;
      left:16px;
      right:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .nameRow{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
    }

    .name{
      font-size:26px;
      font-weight:1000;
      line-height:1.05;
    }

    .meta{
      color:var(--muted);
      font-size:12px;
      line-height:1.25;
      text-align:right;
    }

    .statsRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .stat{
      flex:1;
      min-width: 96px;
      padding:10px 12px;
      border-radius:16px;
      background: rgba(17,24,38,.62);
      border:1px solid rgba(233,238,247,.12);
      backdrop-filter: blur(8px);
    }

    .statLabel{
      color: var(--muted);
      font-size:11px;
      font-weight:900;
      letter-spacing:.2px;
    }

    .statValue{
      margin-top:4px;
      font-size:14px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .tag{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(17,24,38,.65);
      border:1px solid rgba(233,238,247,.12);
      color: var(--text);
      backdrop-filter: blur(8px);
    }

    .badge{
      position:absolute;
      top:18px;
      padding:10px 14px;
      border-radius:14px;
      font-weight:1000;
      letter-spacing:.6px;
      font-size:16px;
      text-transform:uppercase;
      border:2px solid rgba(255,255,255,.6);
      background: rgba(0,0,0,.25);
      transform: rotate(-14deg);
      opacity:0;
      pointer-events:none;
    }

    .badge.like{ left:18px; color: var(--ok); border-color: rgba(77,255,136,.9); }
    .badge.nope{ right:18px; color: var(--danger); border-color: rgba(255,77,109,.9); transform: rotate(14deg); }

    .controls{
      display:flex;
      justify-content:center;
      gap:14px;
      padding: 8px 0 0;
    }

    .btn{
      width:64px;height:64px;border-radius:999px;
      border:1px solid rgba(233,238,247,.16);
      background: rgba(17,24,38,.65);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      color:var(--text);
      font-size:18px;
      font-weight:1000;
      cursor:pointer;
      backdrop-filter: blur(10px);
    }

    .btn:active{ transform: scale(.98); }
    .btn.nope{ outline: 2px solid rgba(255,77,109,.15); }
    .btn.like{ outline: 2px solid rgba(39,242,199,.18); }

    .footer{
      display:flex;
      justify-content:center;
      color:var(--muted);
      font-size:12px;
      padding-bottom: 4px;
      text-align:center;
      padding-left: 8px;
      padding-right: 8px;
    }

    .modalWrap{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.55);
      padding:18px;
      z-index: 50;
    }

    .modal{
      width:min(420px, 100%);
      border-radius: 26px;
      background: rgba(17,24,38,.92);
      border:1px solid rgba(233,238,247,.14);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(14px);
    }

    .modal h2{
      margin:0 0 8px;
      font-size:22px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .modal p{
      margin:0 0 14px;
      color: var(--muted);
      line-height:1.45;
      font-size:14px;
    }

    .modalActions{
      display:flex;
      gap:10px;
    }

    .cta{
      flex:1;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(233,238,247,.16);
      background: rgba(39,242,199,.16);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
    }

    .ghost{
      flex:1;
      padding:12px 14px;
      border-radius: 14px;
      border:1px solid rgba(233,238,247,.16);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:1000;
      cursor:pointer;
    }

    .formGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 10px;
      margin-bottom: 12px;
    }

    .formGrid .full{ grid-column: 1 / -1; }

    input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(233,238,247,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight:900;
      outline:none;
    }

    .smallNote{
      color: var(--muted);
      font-size:12px;
      line-height:1.35;
      margin-top: 8px;
    }

    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom:16px;
      padding:10px 12px;
      border-radius: 999px;
      background: rgba(17,24,38,.88);
      border:1px solid rgba(233,238,247,.14);
      color: var(--muted);
      font-size:12px;
      display:none;
      backdrop-filter: blur(10px);
      z-index: 60;
      max-width: 90vw;
      text-align:center;
    }

    .chatBox{
      height:260px;
      overflow:auto;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(233,238,247,.14);
      background: rgba(255,255,255,.04);
      margin: 10px 0 12px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div class="brandText">Peakz Padel Singles</div>
      </div>
      <div class="rightTop">
        <button class="miniBtn" id="btnAdd">Speler toevoegen</button>
        <div class="pill" id="counter">0 over</div>
      </div>
    </div>

    <div class="filters">
      <select id="clubFilter" aria-label="Filter club">
        <option value="all">Alle clubs</option>
      </select>
      <select id="ratingFilter" aria-label="Minimum rating">
        <option value="0">Alle ratings</option>
        <option value="4">Min 4</option>
        <option value="5">Min 5</option>
        <option value="6">Min 6</option>
        <option value="7">Min 7</option>
        <option value="8">Min 8</option>
        <option value="9">Min 9</option>
      </select>
    </div>

    <div class="deck" id="deck" aria-label="Swipe deck"></div>

    <div class="controls">
      <button class="btn nope" id="btnNope" aria-label="Nope">✕</button>
      <button class="btn like" id="btnLike" aria-label="Like">❤</button>
    </div>

    <div class="footer" id="hint">Swipe rechts voor yes, links voor next</div>
  </div>

  <!-- Match modal -->
  <div class="modalWrap" id="matchWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="matchTitle">Match</h2>
      <p id="matchText">Jullie willen allebei spelen.</p>

      <div class="modalActions">
        <button class="cta" id="btnChat">Chat eerst</button>
        <button class="ghost" id="btnMatchClose">Verder swipen</button>
      </div>

      <div class="modalActions" style="margin-top:10px">
        <button class="cta" id="btnBook">Boek Single baan</button>
        <button class="ghost" id="btnBackToChat">Terug naar chat</button>
      </div>

      <div class="smallNote" id="matchNote"></div>
    </div>
  </div>

  <!-- Add player modal -->
  <div class="modalWrap" id="addWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <h2>Speler toevoegen</h2>
      <p>Deze wordt lokaal opgeslagen in je browser. Perfect voor demo en test.</p>

      <div class="formGrid">
        <input id="fName" placeholder="Naam" class="full" />
        <input id="fAge" placeholder="Leeftijd" inputmode="numeric" />
        <input id="fRating" placeholder="Rating" inputmode="numeric" />
        <input id="fClub" placeholder="Club" class="full" />
        <input id="fMatches" placeholder="Potjes gespeeld" inputmode="numeric" />
        <input id="fAvailability" placeholder="Beschikbaar" />
        <input id="fStyle" placeholder="Speelstijl" class="full" />
        <input id="fPhoto" placeholder="Foto url" class="full" />
      </div>

      <div class="modalActions">
        <button class="cta" id="btnSavePlayer">Opslaan</button>
        <button class="ghost" id="btnAddClose">Sluiten</button>
      </div>

      <div class="smallNote">Tip: laat foto url leeg, dan pakken we een standaard demo foto.</div>
    </div>
  </div>

  <!-- Chat modal -->
  <div class="modalWrap" id="chatWrap" role="dialog" aria-modal="true">
    <div class="modal">
      <h2 id="chatTitle">Chat</h2>
      <p id="chatSub">Maak het kort, prik een moment, ga spelen.</p>

      <div id="chatBox" class="chatBox"></div>

      <div style="display:flex; gap:10px">
        <input id="chatInput" placeholder="Typ je bericht" style="flex:1" />
        <button class="cta" id="btnSend" style="flex:0 0 auto; width:110px">Send</button>
      </div>

      <div class="modalActions" style="margin-top:12px">
        <button class="cta" id="btnChatBook">Boek Single baan</button>
        <button class="ghost" id="btnChatClose">Sluiten</button>
      </div>

      <div class="smallNote" id="chatNote"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // Instellingen
    const mutualLikeBaseChance = 0.40;
    const maxRatingDiffForMatch = 1;

    // Demo profiel van jou
    const me = {
      rating: 6,
      club: "Amsterdam Zuidoost"
    };

    // Booking url basis
    // Vervang dit later door jullie echte Single baan url
    const bookingBaseUrl = "https://peakzpadel.nl";

    // Betrouwbare foto bron
    const fallbackPhoto = "https://randomuser.me/api/portraits/lego/1.jpg";

    // Seed data met vaste foto urls
    const seedProfiles = [
      {
        id:"p1", name:"Noa", age:27, club:"Amsterdam Zuidoost", rating:6, matchesPlayed:84,
        style:"Netjager", availability:"Avonden",
        photo:"https://randomuser.me/api/portraits/women/44.jpg"
      },
      {
        id:"p2", name:"Milan", age:31, club:"Utrecht", rating:5, matchesPlayed:142,
        style:"Glasfluisteraar", availability:"Weekend",
        photo:"https://randomuser.me/api/portraits/men/32.jpg"
      },
      {
        id:"p3", name:"Sara", age:24, club:"Eindhoven", rating:7, matchesPlayed:56,
        style:"Lob queen", availability:"Ochtend",
        photo:"https://randomuser.me/api/portraits/women/68.jpg"
      },
      {
        id:"p4", name:"Jesse", age:29, club:"Rotterdam", rating:6, matchesPlayed:210,
        style:"Smash met beleid", availability:"Middag",
        photo:"https://randomuser.me/api/portraits/men/11.jpg"
      },
      {
        id:"p5", name:"Lina", age:33, club:"Groningen", rating:8, matchesPlayed:118,
        style:"Verdediger", availability:"Avonden",
        photo:"https://randomuser.me/api/portraits/women/22.jpg"
      },
      {
        id:"p6", name:"Bram", age:26, club:"Amsterdam Zuidoost", rating:9, matchesPlayed:320,
        style:"Sloopkogel", availability:"Weekend",
        photo:"https://randomuser.me/api/portraits/men/76.jpg"
      }
    ];

    const storageKeyProfiles = "peakz_swipe_custom_profiles";
    const storageKeyChatPrefix = "peakz_chat_";

    function uniq(arr){ return [...new Set(arr)]; }

    function uid(){
      return "c" + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }

    function loadCustomProfiles(){
      try{
        const raw = localStorage.getItem(storageKeyProfiles);
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed;
      }catch{
        return [];
      }
    }

    function saveCustomProfiles(list){
      localStorage.setItem(storageKeyProfiles, JSON.stringify(list));
    }

    function chatKeyFor(profile){
      return storageKeyChatPrefix + profile.id;
    }

    function loadChat(profile){
      try{
        const raw = localStorage.getItem(chatKeyFor(profile));
        if(!raw) return [];
        const parsed = JSON.parse(raw);
        if(!Array.isArray(parsed)) return [];
        return parsed;
      }catch{
        return [];
      }
    }

    function saveChat(profile, messages){
      localStorage.setItem(chatKeyFor(profile), JSON.stringify(messages));
    }

    // Elements
    const deck = document.getElementById("deck");
    const counter = document.getElementById("counter");
    const hint = document.getElementById("hint");
    const toast = document.getElementById("toast");

    const btnLike = document.getElementById("btnLike");
    const btnNope = document.getElementById("btnNope");

    const clubFilter = document.getElementById("clubFilter");
    const ratingFilter = document.getElementById("ratingFilter");

    const matchWrap = document.getElementById("matchWrap");
    const matchTitle = document.getElementById("matchTitle");
    const matchText = document.getElementById("matchText");
    const matchNote = document.getElementById("matchNote");
    const btnMatchClose = document.getElementById("btnMatchClose");
    const btnBook = document.getElementById("btnBook");
    const btnChat = document.getElementById("btnChat");
    const btnBackToChat = document.getElementById("btnBackToChat");

    const addWrap = document.getElementById("addWrap");
    const btnAdd = document.getElementById("btnAdd");
    const btnAddClose = document.getElementById("btnAddClose");
    const btnSavePlayer = document.getElementById("btnSavePlayer");

    const fName = document.getElementById("fName");
    const fAge = document.getElementById("fAge");
    const fRating = document.getElementById("fRating");
    const fClub = document.getElementById("fClub");
    const fMatches = document.getElementById("fMatches");
    const fAvailability = document.getElementById("fAvailability");
    const fStyle = document.getElementById("fStyle");
    const fPhoto = document.getElementById("fPhoto");

    const chatWrap = document.getElementById("chatWrap");
    const chatTitle = document.getElementById("chatTitle");
    const chatSub = document.getElementById("chatSub");
    const chatBox = document.getElementById("chatBox");
    const chatInput = document.getElementById("chatInput");
    const chatNote = document.getElementById("chatNote");
    const btnSend = document.getElementById("btnSend");
    const btnChatClose = document.getElementById("btnChatClose");
    const btnChatBook = document.getElementById("btnChatBook");

    // State
    let allProfiles = [];
    let profiles = [];
    let index = 0;
    let currentCard = null;
    let activeMatchProfile = null;

    function showToast(text){
      toast.textContent = text;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => toast.style.display = "none", 1400);
    }

    function rebuildAllProfiles(){
      const custom = loadCustomProfiles();
      allProfiles = [...seedProfiles, ...custom];
    }

    function setCounter(){
      const left = Math.max(0, profiles.length - index);
      counter.textContent = left + " over";
    }

    function setupFilters(){
      const currentClub = clubFilter.value || "all";
      clubFilter.innerHTML = '<option value="all">Alle clubs</option>';

      const clubs = uniq(allProfiles.map(p => p.club)).sort();
      for(const c of clubs){
        const opt = document.createElement("option");
        opt.value = c;
        opt.textContent = c;
        clubFilter.appendChild(opt);
      }

      if([...clubFilter.options].some(o => o.value === currentClub)){
        clubFilter.value = currentClub;
      }else{
        clubFilter.value = "all";
      }
    }

    function applyFilters(){
      const clubValue = clubFilter.value;
      const minRating = Number(ratingFilter.value);

      profiles = allProfiles.filter(p => {
        const okClub = clubValue === "all" ? true : p.club === clubValue;
        const okRating = Number(p.rating) >= minRating;
        return okClub && okRating;
      });

      index = 0;
      mountNextCard();

      if(profiles.length === 0){
        hint.textContent = "Geen spelers gevonden. Zet je filters iets losser.";
      }
    }

    function bookingUrlFor(profile){
      const u = new URL(bookingBaseUrl);
      u.searchParams.set("single", "1");
      u.searchParams.set("club", profile.club);
      u.searchParams.set("opponent", profile.name);
      u.searchParams.set("rating", String(profile.rating));
      return u.toString();
    }

    function ratingDiffOk(profile){
      return Math.abs(Number(profile.rating) - Number(me.rating)) <= maxRatingDiffForMatch;
    }

    function matchChance(profile){
      if(!ratingDiffOk(profile)) return 0;
      const sameClubBonus = profile.club === me.club ? 0.12 : 0;
      return Math.min(0.85, mutualLikeBaseChance + sameClubBonus);
    }

    function safeBackgroundImage(el, url){
      const chosen = url || fallbackPhoto;
      el.style.backgroundImage = `url("${chosen}")`;

      const img = new Image();
      img.onerror = () => {
        el.style.backgroundImage = `url("${fallbackPhoto}")`;
      };
      img.src = chosen;
    }

    function createCard(profile){
      const card = document.createElement("div");
      card.className = "card";
      card.dataset.id = profile.id;

      const photo = document.createElement("div");
      photo.className = "photo";
      safeBackgroundImage(photo, profile.photo);

      const shade = document.createElement("div");
      shade.className = "shade";

      const badgeLike = document.createElement("div");
      badgeLike.className = "badge like";
      badgeLike.textContent = "YES";

      const badgeNope = document.createElement("div");
      badgeNope.className = "badge nope";
      badgeNope.textContent = "NEXT";

      const info = document.createElement("div");
      info.className = "info";

      const nameRow = document.createElement("div");
      nameRow.className = "nameRow";

      const name = document.createElement("div");
      name.className = "name";
      name.textContent = `${profile.name}, ${profile.age}`;

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = `${profile.club}`;

      nameRow.appendChild(name);
      nameRow.appendChild(meta);

      const statsRow = document.createElement("div");
      statsRow.className = "statsRow";

      const s1 = document.createElement("div");
      s1.className = "stat";
      s1.innerHTML = `<div class="statLabel">Rating</div><div class="statValue">${profile.rating}</div>`;

      const s2 = document.createElement("div");
      s2.className = "stat";
      s2.innerHTML = `<div class="statLabel">Potjes</div><div class="statValue">${profile.matchesPlayed}</div>`;

      const s3 = document.createElement("div");
      s3.className = "stat";
      s3.innerHTML = `<div class="statLabel">Beschikbaar</div><div class="statValue">${profile.availability}</div>`;

      statsRow.appendChild(s1);
      statsRow.appendChild(s2);
      statsRow.appendChild(s3);

      const tags = document.createElement("div");
      tags.className = "tags";

      const t1 = document.createElement("div");
      t1.className = "tag";
      t1.textContent = profile.style || "Allround";

      const t2 = document.createElement("div");
      t2.className = "tag";
      t2.textContent = "Single baan ready";

      tags.appendChild(t1);
      tags.appendChild(t2);

      info.appendChild(nameRow);
      info.appendChild(statsRow);
      info.appendChild(tags);

      card.appendChild(photo);
      card.appendChild(shade);
      card.appendChild(badgeLike);
      card.appendChild(badgeNope);
      card.appendChild(info);

      attachSwipe(card, badgeLike, badgeNope, profile);
      return card;
    }

    function mountNextCard(){
      deck.innerHTML = "";
      if(index >= profiles.length){
        hint.textContent = "Deck leeg. Pas filters aan of voeg spelers toe.";
        setCounter();
        currentCard = null;
        return;
      }
      const profile = profiles[index];
      currentCard = createCard(profile);
      deck.appendChild(currentCard);
      setCounter();
      hint.textContent = "Swipe rechts voor yes, links voor next";
    }

    function openMatch(profile){
      activeMatchProfile = profile;

      matchTitle.textContent = "Match";
      matchText.textContent = "Jij en " + profile.name + " willen allebei spelen. Eerst even afstemmen, dan boeken.";
      matchNote.textContent = "Match regel: rating verschil maximaal " + maxRatingDiffForMatch + ". Jouw rating " + me.rating + ".";

      matchWrap.style.display = "flex";

      btnChat.onclick = () => {
        matchWrap.style.display = "none";
        openChat(profile);
      };

      btnBackToChat.onclick = () => {
        matchWrap.style.display = "none";
        openChat(profile);
      };

      btnBook.onclick = () => {
        window.location.href = bookingUrlFor(profile);
      };
    }

    function closeMatch(){
      matchWrap.style.display = "none";
    }

    function renderChat(profile){
      const messages = loadChat(profile);
      chatBox.innerHTML = "";

      if(messages.length === 0){
        const empty = document.createElement("div");
        empty.style.color = "rgba(233,238,247,.65)";
        empty.style.fontSize = "13px";
        empty.textContent = "Start met iets simpels. Wanneer speel je en op welke club";
        chatBox.appendChild(empty);
      }

      for(const m of messages){
        const row = document.createElement("div");
        row.style.display = "flex";
        row.style.justifyContent = m.from === "me" ? "flex-end" : "flex-start";
        row.style.margin = "8px 0";

        const bubble = document.createElement("div");
        bubble.style.maxWidth = "78%";
        bubble.style.padding = "10px 12px";
        bubble.style.borderRadius = "16px";
        bubble.style.border = "1px solid rgba(233,238,247,.14)";
        bubble.style.background = m.from === "me" ? "rgba(39,242,199,.14)" : "rgba(255,255,255,.06)";
        bubble.style.fontWeight = "900";
        bubble.style.fontSize = "13px";
        bubble.textContent = m.text;

        row.appendChild(bubble);
        chatBox.appendChild(row);
      }

      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function openChat(profile){
      activeMatchProfile = profile;
      chatTitle.textContent = "Chat met " + profile.name;
      chatSub.textContent = profile.club + " • rating " + profile.rating;
      chatNote.textContent = "Tip: prik een moment, kies een club, dan boeken.";
      chatInput.value = "";
      renderChat(profile);
      chatWrap.style.display = "flex";
      setTimeout(() => chatInput.focus(), 50);
    }

    function closeChat(){
      chatWrap.style.display = "none";
    }

    function sendMessage(text, from){
      if(!activeMatchProfile) return;
      const t = (text || "").trim();
      if(!t) return;

      const messages = loadChat(activeMatchProfile);
      messages.push({ from, text: t, ts: Date.now() });
      saveChat(activeMatchProfile, messages);
      renderChat(activeMatchProfile);
    }

    function botReply(){
      const p = activeMatchProfile;
      if(!p) return;

      const replies = [
        "Lekker. Wanneer kan je",
        "Welke club pakken we",
        "Zin in 90 minuten",
        "Ik kan vanavond of weekend",
        "Top. Zullen we meteen boeken"
      ];
      const pick = replies[Math.floor(Math.random() * replies.length)];

      setTimeout(() => {
        sendMessage(pick, "them");
      }, 450);
    }

    function onDecision(direction, profile){
      const liked = direction === "like";
      showToast(liked ? "Yes" : "Next");

      let isMatch = false;
      if(liked){
        const chance = matchChance(profile);
        if(chance === 0){
          showToast("Te groot rating verschil");
        }else{
          isMatch = Math.random() < chance;
        }
      }

      index += 1;
      mountNextCard();

      if(isMatch){
        openMatch(profile);
      }
    }

    function animateOut(card, x, rot){
      card.style.transition = "transform 240ms ease";
      card.style.transform = `translate3d(${x}px, 0, 0) rotate(${rot}deg)`;
      setTimeout(() => { card.style.transition = ""; }, 260);
    }

    function attachSwipe(card, badgeLike, badgeNope, profile){
      let startX = 0;
      let startY = 0;
      let currentX = 0;
      let currentY = 0;
      let dragging = false;
      const threshold = 110;

      function setBadges(dx){
        const likeOpacity = Math.max(0, Math.min(1, dx / 140));
        const nopeOpacity = Math.max(0, Math.min(1, (-dx) / 140));
        badgeLike.style.opacity = likeOpacity.toFixed(2);
        badgeNope.style.opacity = nopeOpacity.toFixed(2);
      }

      function pointerDown(e){
        dragging = true;
        const p = e.touches ? e.touches[0] : e;
        startX = p.clientX;
        startY = p.clientY;
        currentX = 0;
        currentY = 0;
        card.style.transition = "";
      }

      function pointerMove(e){
        if(!dragging) return;
        const p = e.touches ? e.touches[0] : e;
        currentX = p.clientX - startX;
        currentY = p.clientY - startY;

        const rot = currentX / 18;
        card.style.transform = `translate3d(${currentX}px, ${currentY}px, 0) rotate(${rot}deg)`;
        setBadges(currentX);
      }

      function pointerUp(){
        if(!dragging) return;
        dragging = false;

        if(currentX > threshold){
          setBadges(200);
          animateOut(card, 520, 18);
          onDecision("like", profile);
          return;
        }

        if(currentX < -threshold){
          setBadges(-200);
          animateOut(card, -520, -18);
          onDecision("nope", profile);
          return;
        }

        badgeLike.style.opacity = "0";
        badgeNope.style.opacity = "0";
        card.style.transition = "transform 220ms ease";
        card.style.transform = "translate3d(0,0,0) rotate(0deg)";
      }

      card.addEventListener("touchstart", pointerDown, {passive:true});
      card.addEventListener("touchmove", pointerMove, {passive:true});
      card.addEventListener("touchend", pointerUp);
      card.addEventListener("mousedown", pointerDown);
      window.addEventListener("mousemove", pointerMove);
      window.addEventListener("mouseup", pointerUp);

      btnLike.onclick = () => {
        if(!currentCard) return;
        badgeLike.style.opacity = "1";
        animateOut(card, 520, 18);
        onDecision("like", profile);
      };

      btnNope.onclick = () => {
        if(!currentCard) return;
        badgeNope.style.opacity = "1";
        animateOut(card, -520, -18);
        onDecision("nope", profile);
      };
    }

    function openAdd(){ addWrap.style.display = "flex"; }
    function closeAdd(){ addWrap.style.display = "none"; }

    btnAdd.addEventListener("click", openAdd);
    btnAddClose.addEventListener("click", closeAdd);
    addWrap.addEventListener("click", (e) => { if(e.target === addWrap) closeAdd(); });

    btnSavePlayer.addEventListener("click", () => {
      const name = (fName.value || "").trim();
      const club = (fClub.value || "").trim();
      const style = (fStyle.value || "").trim() || "Allround";
      const availability = (fAvailability.value || "").trim() || "Avonden";
      const photo = (fPhoto.value || "").trim();

      const age = Number((fAge.value || "").trim());
      const rating = Number((fRating.value || "").trim());
      const matchesPlayed = Number((fMatches.value || "").trim());

      if(!name || !club || !Number.isFinite(age) || !Number.isFinite(rating) || !Number.isFinite(matchesPlayed)){
        showToast("Vul naam club leeftijd rating potjes in");
        return;
      }

      const newProfile = {
        id: uid(),
        name,
        age,
        club,
        rating,
        matchesPlayed,
        style,
        availability,
        photo
      };

      const custom = loadCustomProfiles();
      custom.push(newProfile);
      saveCustomProfiles(custom);

      fName.value = "";
      fAge.value = "";
      fRating.value = "";
      fClub.value = "";
      fMatches.value = "";
      fAvailability.value = "";
      fStyle.value = "";
      fPhoto.value = "";

      rebuildAllProfiles();
      setupFilters();
      applyFilters();
      closeAdd();
      showToast("Speler toegevoegd");
    });

    btnMatchClose.addEventListener("click", closeMatch);
    matchWrap.addEventListener("click", (e) => { if(e.target === matchWrap) closeMatch(); });

    btnChatClose.addEventListener("click", closeChat);
    chatWrap.addEventListener("click", (e) => { if(e.target === chatWrap) closeChat(); });

    btnChatBook.addEventListener("click", () => {
      if(!activeMatchProfile) return;
      window.location.href = bookingUrlFor(activeMatchProfile);
    });

    btnSend.addEventListener("click", () => {
      sendMessage(chatInput.value, "me");
      chatInput.value = "";
      botReply();
    });

    chatInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        btnSend.click();
      }
    });

    clubFilter.addEventListener("change", applyFilters);
    ratingFilter.addEventListener("change", applyFilters);

    // Init
    rebuildAllProfiles();
    setupFilters();
    applyFilters();
  </script>
</body>
</html>
